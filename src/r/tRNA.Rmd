---
title: "tRNA"
author: "Dmytro Strunin"
date: "4/15/2021"
output: html_document
---

```{r setup, include = FALSE, message = FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(parallel)
library(tidyverse)
library(tRNA)
library(tRNAscanImport)
```

# tRNA scan

tRNAs sequences, positions in genome, and structures were predicted by `tRNAscan-SE` tool (see the [trnascan.sh script](../../src/sh/trnascan.sh)).

```{r}
struct_files <- list.files('../../dat/out/trs/struct/', full.names = T)
struct_fl_sz <- sapply(struct_files, file.size)

empty_file <- gsub('(.*)\\.struct', '\\1', basename(struct_files[struct_fl_sz == 0]))
```

There is missing information for the `r empty_file` strain, we will omit it in the following analysis.

```{r}
ncores <- detectCores()

cl     <- makeCluster(ncores)

struct_files <- struct_files[struct_fl_sz != 0]

trnas <- parLapply(
  cl,
  struct_files,
  import.tRNAscanAsGRanges
)
```

# Making the List of granges

```{r}
set.seed(011235813)
samples <- sample(length(trnas), 8)
grl_smpl <- GRangesList(trnas[samples])
grl_smpl_names <- gsub('(.*)\\.struct', '\\1', basename(struct_files[samples]))
names(grl_smpl) <- grl_smpl_names

grl <- GRangesList(trnas)
grl_names <- gsub('(.*)\\.struct', '\\1', basename(struct_files))
names(grl) <- grl_names
```

# Plot some tRNA features

```{r}
plots <- gettRNAFeaturePlots(grl_smpl)
```

## tRNA length

```{r}
plots$length + ggthemes::theme_few()
```
## Variable loop length

```{r}
plots$variableLoop_length + ggthemes::theme_few()
```

## t-stem length

```{r}
plots$TStem_length + ggthemes::theme_few()
```
## tRNAscan-SE score

```{r}
plots$tRNAscan_score + ggthemes::theme_few()
```

# tRNA count

```{r}
trna_counts <- lapply(
  names(grl),
  function(i){
    data.frame(
          tRNA   = grl[[i]]$tRNA_type,
          strain = i
    )
  }
)

trna_counts <- do.call(rbind, trna_counts) %>%
  count(strain, tRNA) %>%
  group_by(strain) %>%
  arrange(tRNA, desc(n)) %>%
  head(50) %>%
  View()
  #mutate(n = n / sum(n) * 100)

head(trna_counts)
```

## Plot tRNA counts

```{r}
trna_counts %>%
  group_by(tRNA) %>%
  mutate(tmp = median(n, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(tRNA = fct_reorder(tRNA, tmp), tmp = NULL) %>%
  ggplot(aes(x = tRNA, y = n)) +
  #geom_jitter() +
  geom_boxplot(fill = NA) +
  #scale_y_continuous(breaks = 1:15, labels = as.character(1:15)) +
  coord_flip() +
  labs(
    x = 'tRNA',
    y = 'tRNA genes count, %'
  ) +
  ggthemes::theme_few()
```

